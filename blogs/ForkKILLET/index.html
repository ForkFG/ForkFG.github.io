<!doctype html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html" charset="UTF-8"/>
		<title>ForkKΨILLET's Blog</title>

		<link rel="stylesheet" type="text/css" href="https://icelava.ga/style.css">
		<link rel="stylesheet" type="text/css" href="https://icelava.ga/fa/css/font-awesome.min.css">
		<script type="text/javascript" src="https://icelava.ga/marked.min.js"></script>
		<script type="text/javascript" src="https://cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
		<script type="text/javascript" src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
		<script type="text/javascript" src="https://icelava.ga/jquery.color.js"></script>


		<!-- Note: 代码高亮 -->
		<link rel="stylesheet"  href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/styles/default.min.css">
		<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/highlight.min.js"></script>
		<script src="https://icelava.ga/highlight/highlight.pack.js"></script>

		<style>
			#main
			{
				z-index: -3;
			}
			#m_search
			{
				position: relative;
				z-index: -3;
			}
			#search
			{
				transition: margin-top 1s;
				position: relative;
				z-index: -2;
			}
			#search_cover
			{
				display: block;
				position: absolute;
				z-index: -1;
				top: 0;
				width: 100%;
				height: 150px;
				background-color: #ffffff;
			}
			#btn_back
			{
				position: absolute;
				right: 35px;
				top: 15px;
				background-color: white;
				box-shadow: 0 3px 10px #0000004D;
			}
		</style>
	</head>
	<body>
		<p id="pos" class="title">ForkΨKILLET's Blog</p>
		<div id="main">
			<div id="m_search">
				<div>
					<p class="title">
						<i class="fa fa-list"></i> ForkΨKILLET 的文章列表
					</p>
				</div> <br>
				<p class="text no-gap center" id="search_title">
					<b>文章筛选器
					<i id="btn_hide_search" class="fa fa-angle-up"></i>
					<i id="btn_show_search" class="fa fa-angle-down"></i> </b> <br><br>
				</p>

				<div id="search_cover"></div>

				<div id="search" class="center">
					<p class="text no-gap">
						<i>请您搜索时，宁可少字不要错字，这样搜索的结果会更符合您的预期！</i> <br><br>
						<i class="fa fa-fw fa-header"></i>
						<input id="input_title" type="text" name="title" placeholder="搜索文章标题" spellcheck="false" autocomplete="off">
						<br>

						<i class="fa fa-fw fa-tag"></i>
						<input id="input_tag" type="text" name="title" placeholder="搜索文章标签" spellcheck="false" autocomplete="off">
						<br>
						已选择的标签：<span id="tags_1"></span><br>
						搜索到的标签：<span id="tags_2"></span><br>
					</p>
					<div id="search_submit" class="button">搜索</div>
				</div> <hr>

				<div id="contents"></div>
			</div>

			<div id="m_article" class="md"></div>
		</div>
		<script type="text/javascript" src="https://icelava.ga/main.js"></script>
		<script type="text/javascript">
			// Note: 筛选器的隐藏、显示特效。
			let $search = $("#search");
			$search.data("show", true);
			$("#btn_show_search").hide();
			$("#search_title").click(function()
			{
				$("#btn_hide_search").toggle();
				$("#btn_show_search").toggle();
				if ($search.data("show") === true)
				{
					$search.data("show", false);
					$search.css("marginTop", "-400px");
				}
				else
				{
					$search.data("show", true);
					$search.css("marginTop", "0");
				}
			});

			// Note: 重要：AJAX 请求返回目录摘要。

			let $search_submit = $("#search_submit");
			function upd_contents()
			{
				$search_submit.html(`搜索中 <i class="fa fa-spinner fa-spin">`);

				let s = "",
				title = $("#input_title").val(),
				tag = window.chosen_tags;

				if (title || tag)
				{
					s += "?";
					if (title)
					{
						s += "title=" + title;
						if (tag)s += "&";
					}
					if (tag)s += "tag=" + tag;
				}

				AJAX("GET", "http://loli.icelava.ga/reader.php" + s, "application/x-www-form-urlencoded", null,
				function(XHR)
				{
					$("#search_submit").html("搜索");
					$("#contents").html(XHR.responseText);

					$("#contents>a").click(function()
					{
						$("#m_search").hide();
						$("#btn_back").show();
						let $m_article = $("#m_article");
						$m_article.html(`<p class='title'><i class='fa fa-spinner fa-spin'></i> 页面内容正在加载中，请稍等</p>`);
						$m_article.show();

						AJAX("GET", "http://loli.icelava.ga/load_md.php?name=blogs/ForkKILLET/" + $(this).data("name"), "application/x-www-form- urlencoded", null,
						function(XHR)
						{
							$m_article.html(marked(XHR.responseText));
							MathJax.Hub.Queue(["Typeset", MathJax.Hub, $m_article[0]]);

							$("#btn_back").click(function()
							{
								$("#m_search").show();
								$("#m_article").hide();
								$("#btn_back").hide();
							});
						});
					});
				});
			}
			$search_submit.click(upd_contents);
			upd_contents();

			// Note: 插入 返回目录 按钮
			$("#pos").after(`<div id="btn_back" class="button">返回目录</div>`);
			$("#btn_back").hide();

			// Note: 标签系统

			function e_tag(text)
			{
				return `<span class="tag">` + text + `</span>`;
			}

			window.chosen_tags = "";

			let $t1 = $("#tags_1");
			let $t2 = $("#tags_2");
			$t1.html(e_tag("None"));
			$t2.html(e_tag("None"));

			AJAX("GET", "http://loli.icelava.ga/get_tags.php", "application/x-www-form- urlencoded", null,
			function(XHR)
			{
				window.tags = JSON.parse(XHR.responseText);
				$("#input_tag").on("input propertychange", function()
				{
					$t2.html(e_tag("None"));
					for (let t in tags)
					{
						let v = $(this).val();
						if (v !== "" && tags[t].match(RegExp(v)))
						{
							$t2.append(e_tag(tags[t]));
							let $i = $("#tags_2>.tag:first-child");
							if ($i[0].innerHTML === "None")
								$i.remove();

							$("#tags_2>.tag:last-child").click(function()
							{
								if ($(this)[0].innerHTML === "None")return;
								if ($(this).parent()[0].id === "tags_2")
								{
									if (!window.chosen_tags.match("@" + $(this)[0].innerHTML))
									{
										$(this).appendTo($t1);
										let $i = $("#tags_1>.tag:first-child");
										if ($i[0].innerHTML === "None")
											$i.remove();

										window.chosen_tags += "@" + $(this)[0].innerHTML;
									}
									$t2.html(e_tag("None"));
									$("#input_tag").val("");
								}
								else
								{
									$(this).remove();
									if ($t1.children().length === 0)
										$t1.html(e_tag("None"));
									window.chosen_tags = window.chosen_tags.replace("@" + $(this)[0].innerHTML, "");
								}
							});
						}
					}
				});
			});
		</script>
	</body>
</html>